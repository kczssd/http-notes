## 图解HTTP(5)

### HTTP+加密+认证+完整性保护=HTTPS

---

> 通常HTTP直接和TCP通信，当使用SSL时，则会先和SSL通信再由SSL和TCP通信

1. **HTTP的缺点**
   1. 通信使用明文，内容可能被窃听
   2. 不验证通信方的身份，可能被伪装
   3. 无法证明报文的完整性，可能已遭篡改(**中间人攻击**)
2. **HTTPS的缺点**
   1. 网络负载慢2倍以上，通信量增加
   2. 消耗CPU及内存资源，负载增强

---

#### 两种加密方式

1. **通信加密**

   ​	HTTP通过和SSL或TLS的组合使用，加密HTTP的通信内容。使用SSL建立安全通信线路后就可以在这条线上进行通信了。

2. **内容加密**

   ​	把HTTP报文里所含有的内容进行加密处理。前提是要求客户端和服务端都含有加密和解密机制。

#### 加密方法

1. **对称(共享)密钥加密**

   ​	加密解密使用相同密钥，但发送密钥本身就存在安全隐患。

2. **公开密钥加密**

   ​	采用一对非对称密钥，一个**私有密钥**，一个**公开密钥**。发送密文的一方使用对方的公开密钥进行加密，对方收到后使用自己的私有密钥进行解密，这样不用发送私有密钥。

3. **混合加密机制(HTTPS)**

   ​	公开密钥速度比共享密钥慢。使用公开密钥来交换在稍后使用的密钥，确保安全后使用共享密钥的方式进行通信。

---

#### SSL证书确认通信方

> 证书又值得信任的第三方机构颁发，用以证明服务器和客户端是**实际存在**的。

1. 服务器把自己的公开密钥登录至数字证书认证机构
2. 数字证书认证机构用自己的私有密钥向服务商的公开密码数字签名并颁发公钥证书
3. 客户端拿到服务器的公钥证书后，使用数字证书认证机构的公开密钥，向数字证书认证机构验证公钥证书上的数字签名，以确认服务器的公开密钥的真实性
   1. 数字证书认证机构的公开密钥已事先植入到浏览器里了
4. 使用服务器的公开密钥对报文加密后发送
5. 服务器用私有密钥对报文进行解密

> 使用自签名证书，无法确认连接安全性或网站的安全证书存在问题。

---

#### HTTPS的安全通信机制

| 客户端                                                       | 服务端                                                   |
| ------------------------------------------------------------ | -------------------------------------------------------- |
| 发送Client Hello报文开始SSL通信                              |                                                          |
|                                                              | 以Server Hello报文回应                                   |
|                                                              | 发送Certificate报文，包含**公开密钥**证书                |
|                                                              | 发送Server Hello Done报文通知客户端，SSL部分握手协商结束 |
| 以Client Key Exchange报文回应，包含使用**公开密钥**加密的**Pre-master secret**的随机密码串 |                                                          |
| 发送Change Cipher Spec报文提示服务器之后通信采用**Pre-master secret**密钥加密 |                                                          |
| 发送Finished报文，包含全部报文的整体校验值。以服务器能否解密作为握手协商成功标准 |                                                          |
|                                                              | 发送Change Cipher Spec报文                               |
|                                                              | 发送Finished报文                                         |
| Finished报文交换完毕后，SSL建立完成。开始应用层的通信，发送HTTP请求 |                                                          |
|                                                              | 发送HTTP请求                                             |
| 发送close_notify报文断开连接                                 |                                                          |
|                                                              | 发送TCP FIN报文关闭TCP连接                               |

